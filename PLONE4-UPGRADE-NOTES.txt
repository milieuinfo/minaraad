Notes on Minaraad Plone 4 migration
===================================


Installing on servers
---------------------

We first need a python 2.6 virtual env and a few more libraries.

  > sudo -E apt-get install python-virtualenv python2.6-dev libxml2 libxslt1-dev python-imaging
  > cd ~
  > mkdir virtual_envs
  > cd virtual_envs
  > virtualenv -p /usr/bin/python2.6 py26_mina_plone4

We need the virtualenv otherwise we get an error saying distribute
can't be installed.


To do on Plone 3 through the web
--------------------------------

- Go to the portal_quickinstaller and uninstall CacheSetup.

- Go to the minaraad service panel (minaraad_service) linked in the
  Site Setup and search for duplicate email addresses ('Vind email
  adressen met meerdere gebruikers').  If any are found, use the links
  to delete the duplicates.  Two were reported at the time of writing,
  but Jurgen has removed them.

  Could be done in Plone 4 too, or you can manually remove them in the
  Users and Groups control panel, but it is better to clean them up soon.

- Uninstall emaillogin.

- Uninstall Products.FCKeditor (it gives a problem during migration
  and we want to use TinyMCE now).

- You have to manually remove some skin layers from the Plone Default
  skin selection.  Go to portal_skins in the ZMI, then the Properties
  tab, remove the next skin layers from the Plone Default list and
  click Save:

  - cache_setup

  - emaillogin

  - fckeditorplone

  - fckeditor

- Recently the main_template.pt was changed slightly through the web.
  This must be undone when going to Plone 4.  Go to the portal_skins
  in the ZMI, then to the custom skin folder, and remove
  'main_template' if it is there.

- There is a difference between the minaraad Components registry and a
  default Plone 3.1.7 registry.  This should be added in minaraad while
  still using Plone 3.1.7, in the Components tab, otherwise you get a
  ComponentLookupError on IPortalTransformsTool when upgrading to
  Plone 4::

    <utility
       interface="Products.PortalTransforms.interfaces.IPortalTransformsTool"
       object="portal_transforms"/>


To do on Plone 4
----------------

- Note: the migration takes a lot of memory.  6 GB is advised.

- Stop supervisor and switch to the new buildout tag.

- Use the new python from the virtualenv to bootstrap the buildout.

  $ /home/zope/virtual_envs/py26_mina_plone4/bin/python2.6 bootstrap.py

- Check that the bin/buildout command has the python2.6 command from
  the virtual env in the first line.

- Run bin/buildout.

- Start supervisor: bin/supervisord

- Stop memmon, anders kan het zijn dat de zope instantie herstart
  wordt bij te hoog geheugengebruik: bin/supervisorctl stop memmon

- Run the Plone migration in the ZMI.

- The site should fail now (no portlet_recent), that's "normal". Go to
  @@manage-portlets (at the root of the site) and remove
  the recent portlet.

- Go to the control panel then the skins, select "(Onbewerkt)".

- Go to the extra-products page and:
    - uninstall Kupu
    - install diazo
    - install Quintagroup Captcha Core
    - install collective.emaillogin4
    - plone.app.caching (HTTP caching support)
    - upgrade Simple attachments (note: this takes some time, so use a
      tunnel to access the zope port directly. And it might reset the
      instance too, weird ...)
    - upgrade minaraad.projects
    - upgrade minaraad
   
- Go the the ZMI, portal_setup, import tab. Select "CMFEditions" and
  import all steps.

- Go to the Theme Settings page (@@theming-controlpanel), select the
  "Minaraad" theme and enable it.

- Add the following portlets on the root of the site (so not the front-page):
  - left column: Minaraad login, Minaraad personal preferences
  - right column: Minaraad search, LinkedIn, Minaraad recent changes

- Configure plone.app.caching (not much was previously cached in
  CacheSetup though).

  - Global settings:
    - Enable caching
  - Caching proxies:
    - Enable purging
    - Caching proxies: pick the right servers. For production it is:
      http://plone-minaraad-pr-1.mmis.be:12080
      http://plone-minaraad-pr-2.mmis.be:12080
    - Check 'Virtual host rewriting takes place front of the caching proxy'

- Set the default editor to TinyMCE.  Go to @@set-default-editor page,
  and follow the instructions at the top in two steps:

  - First select TinyMCE and set this as the default editor.

  - Then select 'Standaard gebruik website' and set this in the
    preferences of each existing user.

- Go to the MailHost in the ZMI, enable 'Use mail queue' and set the
  Queue directory to /home/zope/buildout/var/zopemailq.  The directory
  should NOT exist yet.  It will be created with the appropriate
  Maildir subdirectories.  If these options are not available, let
  Maurits know.  There were a bit too many changes in the minaraad
  mail setup recently in Plone 3.

  The SMTP host should be: smtp-plone.mmis.be.

  If 'Status of queue processor thread' says it is stopped, then there
  should be a link 'Start queue processor thread' and you should click
  on it.

- Start memmon weer: bin/supervisorctl start memmon
