Notes on Minaraad Plone 4 migration
===================================

- Currently we have Plone 3.1.7.

- We should move to the latest stable release, currently Plone 4.1.2.


Some dangers to think of
------------------------

- CacheSetup. Should be uninstalled in Plone 3.  Hopefully nothing
  then breaks when starting up under Plone 4.  So far so good.

- We use collective.emaillogin.  This has been merged into Plone 4.0
  so we should not ship with the package itself.  We need to check for
  changes we made to the login machinery.

- Maybe a few fixes are needed for OrderableReferenceField (which we
  have created ourselves, to order references to contact persons),
  although 1.2-beta4 at least claims Plone 4 compatibility:

  http://pypi.python.org/pypi/Products.OrderableReferenceField/
  Have a look at the issue tracker too:
  http://plone.org/products/orderablereferencefield/issues

- E-mail sending has seen a few changes and needs to be checked.
  Maybe port our custom code to use collective.watcherlist.  No
  distinction needs to be made anymore between physical post and
  e-mail subscribers, so that may simplify things a bit and allow us
  to get rid of some code.

- Products.FCKeditor has no release that works on Plone 4.  Buildout
  works fine and the instance can start, but I get an error when
  running the Plone migration, even after uninstalling FCKeditor in
  Plone 4::

    TransformException: Invalid transform : ITransform is not
    implemented by
    Products.FCKeditor.transforms.fck_ruid_to_url.fck_ruid_to_url

  Manually removing fck_ruid_to_url from portal_transforms in the ZMI
  could fix that.

  We probably need to uninstall FCKeditor in Plone 3 (which removes
  that transform automatically).  Then either install
  collective.ckeditor or use TinyMCE.  We will need to use
  collective.setdefaulteditor too, and probably update that code a bit
  to make use of the new option in Plone 4 to just use the system
  default instead of explicitly setting everyone's preference to the
  new editor.


To do on Plone 3 through the web
--------------------------------

- Go to the portal_quickinstaller and uninstall CacheSetup.

- Uninstall emaillogin.

- Uninstall FCKeditor.

- You have to manually remove some skin layers from the Plone Default
  skin selection:

  - cache_setup

  - emaillogin

  - fckeditorplone

  - fckeditor

- You can now remove fckeditor.html from the custom skin layer.

- There is a difference between the minaraad Components registry and a
  default Plone 3.1.7 registry.  This should be added in minaraad while
  still using Plone 3.1.7, in the Components tab, otherwise you get a
  ComponentLookupError on IPortalTransformsTool when upgrading to
  Plone 4 (probably also fine to do this just before doing the Plone
  migration TTW)::

    <utility
       interface="Products.PortalTransforms.interfaces.IPortalTransformsTool"
       object="portal_transforms"/>

  Add that somewhere in the utilities tag on the Components tab.

  Note that Plone 3.1.7 also has the next few lines, but those objects
  do not exist in minaraad, so let's not add them; ah, even if you try
  to add them Zope ignores them and does not actually add them::

    <utility interface="plone.app.i18n.locales.interfaces.IContentLanguages"
       object="plone_app_content_languages"/>
    <utility interface="plone.app.i18n.locales.interfaces.ICountries"
       object="plone_app_countries"/>
    <utility interface="plone.app.i18n.locales.interfaces.IMetadataLanguages"
       object="plone_app_metadata_languages"/>


To do in the buildout
---------------------

- Check which versions can be removed from versions.cfg as they are
  already pinned elsewhere.  Preferably do not remove versions from no
  longer used recipes though, as the pins are needed for uninstall
  too.

- Fix the test part.

- Test RelStorage with blobstorage.  TEST IT WELL!!!  There is some
  confusion (at least for me) between the names of the options and
  where to put them.  See:

  - http://pypi.python.org/pypi/RelStorage
  - http://pypi.python.org/pypi/plone.recipe.zope2instance

- The i18noverrides should no longer be used.  The fixes should be
  done in the code (locales directory).


To do in the code
-----------------

- The i18noverrides buildout part should no longer be used.  The fixes
  should somehow be done in the code, making sure we override
  translations properly.  Maurits probably knows how this can be done,
  but needs to look that up again. :-) See
  http://maurits.vanrees.org/weblog/archive/2010/10/i18n-plone-4#overriding-translations

- Fix errors during Plone migration.


To do on Plone 4 through the web
--------------------------------

- Run the Plone migration.

- Configure plone.app.caching (not much was previously cached in
  CacheSetup though).
